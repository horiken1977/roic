name: EDINET Data Fetch & Update (DISABLED)

on:
  # å®šæœŸå®Ÿè¡Œã‚’ç„¡åŠ¹åŒ–
  # schedule:
  #   - cron: '0 0 * * *'  # UTC 00:00 = JST 09:00
  
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿
  workflow_dispatch:
    inputs:
      companies:
        description: 'å–å¾—ã™ã‚‹ä¼æ¥­ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šï¼‰'
        required: false
        default: 'ãƒˆãƒ¨ã‚¿,ã‚½ãƒ‹ãƒ¼,ä¸‰è±UFJ,ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°,ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹'
      years:
        description: 'å–å¾—ã™ã‚‹å¹´åº¦ç¯„å›²'
        required: false
        default: '2019-2023'

env:
  NODE_VERSION: 18

jobs:
  fetch-edinet-data:
    name: Fetch EDINET Data
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°æ¨©é™
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install dependencies
      run: |
        npm install axios xml2js jszip
    
    - name: Create data fetcher script
      run: |
        cat > fetch-edinet-data.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const https = require('https');
        
        class GitHubActionsEDINETFetcher {
          constructor() {
            this.apiKey = process.env.EDINET_API_KEY;
            this.baseUrl = 'https://disclosure.edinet-fsa.go.jp/api/v2';
            this.outputDir = './public/data/edinet';
            
            if (!this.apiKey) {
              throw new Error('EDINET_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            // å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
            if (!fs.existsSync(this.outputDir)) {
              fs.mkdirSync(this.outputDir, { recursive: true });
            }
          }
        
          async fetchDocumentsForDate(date) {
            return new Promise((resolve, reject) => {
              const url = `${this.baseUrl}/documents.json?date=${date}&type=2&Subscription-Key=${this.apiKey}`;
              
              https.get(url, (res) => {
                let data = '';
                res.on('data', (chunk) => data += chunk);
                res.on('end', () => {
                  try {
                    const result = JSON.parse(data);
                    resolve(result.results || []);
                  } catch (error) {
                    reject(error);
                  }
                });
              }).on('error', reject);
            });
          }
        
          async searchCompaniesFromRecentDocuments(targetCompanies) {
            const companies = new Map();
            const dates = this.getRecentBusinessDates(30);
            
            console.log(`éŽåŽ»30å–¶æ¥­æ—¥ã®æ›¸é¡žã‹ã‚‰ä¼æ¥­ã‚’æ¤œç´¢ä¸­...`);
            
            for (const date of dates.slice(0, 10)) {
              try {
                console.log(`æ—¥ä»˜ ${date} ã‚’æ¤œç´¢ä¸­...`);
                const documents = await this.fetchDocumentsForDate(date);
                
                const securitiesReports = documents.filter(doc => 
                  doc.docTypeCode === '120' && doc.xbrlFlag === '1'
                );
                
                for (const doc of securitiesReports) {
                  for (const targetName of targetCompanies) {
                    if (this.matchesCompany(doc, targetName)) {
                      companies.set(doc.edinetCode, {
                        edinetCode: doc.edinetCode,
                        companyName: doc.filerName,
                        tickerSymbol: doc.secCode,
                        industry: this.estimateIndustry(doc.filerName),
                        latestDocumentDate: doc.submitDateTime,
                        hasRecentData: true
                      });
                      console.log(`âœ“ è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${doc.filerName} (${doc.edinetCode})`);
                    }
                  }
                }
              } catch (error) {
                console.warn(`æ—¥ä»˜ ${date} ã§ã‚¨ãƒ©ãƒ¼:`, error.message);
              }
            }
            
            return Array.from(companies.values());
          }
          
          matchesCompany(document, targetName) {
            const filerName = document.filerName.toLowerCase();
            const target = targetName.toLowerCase();
            
            return filerName.includes(target) || 
                   (document.secCode && document.secCode.includes(targetName));
          }
          
          estimateIndustry(companyName) {
            const industryKeywords = {
              'è¼¸é€ç”¨æ©Ÿå™¨': ['è‡ªå‹•è»Š', 'ãƒˆãƒ¨ã‚¿', 'ãƒ›ãƒ³ãƒ€', 'æ—¥ç”£'],
              'é›»æ°—æ©Ÿå™¨': ['ã‚½ãƒ‹ãƒ¼', 'ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯', 'ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹'],
              'éŠ€è¡Œæ¥­': ['éŠ€è¡Œ', 'ãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«', 'UFJ'],
              'å°å£²æ¥­': ['ãƒ¦ãƒ‹ã‚¯ãƒ­', 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°'],
              'æƒ…å ±ãƒ»é€šä¿¡æ¥­': ['ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯', 'NTT']
            };
            
            for (const [industry, keywords] of Object.entries(industryKeywords)) {
              if (keywords.some(keyword => companyName.includes(keyword))) {
                return industry;
              }
            }
            return 'è£½é€ æ¥­';
          }
          
          getRecentBusinessDates(days) {
            const dates = [];
            const today = new Date();
            let current = new Date(today);
            
            while (dates.length < days) {
              if (current.getDay() !== 0 && current.getDay() !== 6) {
                dates.push(current.toISOString().split('T')[0]);
              }
              current.setDate(current.getDate() - 1);
            }
            
            return dates;
          }
          
          async generateSampleFinancialData(companies, years) {
            const financialDataMap = {};
            
            const baseData = {
              'ãƒˆãƒ¨ã‚¿': {
                netSales: 31379500000000,
                operatingIncome: 2725000000000,
                totalAssets: 53713000000000,
                shareholdersEquity: 23913000000000,
                taxRate: 0.28
              },
              'ã‚½ãƒ‹ãƒ¼': {
                netSales: 12974000000000,
                operatingIncome: 1308000000000,
                totalAssets: 24166000000000,
                shareholdersEquity: 6835000000000,
                taxRate: 0.27
              }
            };
            
            for (const company of companies) {
              financialDataMap[company.edinetCode] = {};
              
              for (const year of years) {
                const companyBaseKey = Object.keys(baseData).find(key => 
                  company.companyName.includes(key)
                ) || 'ãƒˆãƒ¨ã‚¿';
                
                const base = baseData[companyBaseKey];
                const variation = 1 + (Math.random() - 0.5) * 0.1;
                const growth = Math.pow(1.03, year - 2022);
                
                financialDataMap[company.edinetCode][year] = {
                  fiscalYear: year,
                  edinetCode: company.edinetCode,
                  companyName: company.companyName,
                  netSales: Math.round(base.netSales * variation * growth),
                  grossProfit: Math.round(base.netSales * 0.19 * variation * growth),
                  operatingIncome: Math.round(base.operatingIncome * variation * growth),
                  interestIncome: Math.round(base.netSales * 0.003 * variation),
                  sellingAdminExpenses: Math.round(base.netSales * 0.104 * variation * growth),
                  totalAssets: Math.round(base.totalAssets * variation * growth),
                  cashAndEquivalents: Math.round(base.totalAssets * 0.091 * variation),
                  shareholdersEquity: Math.round(base.shareholdersEquity * variation * growth),
                  interestBearingDebt: Math.round(base.totalAssets * 0.164 * variation),
                  accountsPayable: Math.round(base.totalAssets * 0.052 * variation * growth),
                  accruedExpenses: Math.round(base.totalAssets * 0.022 * variation * growth),
                  leaseExpense: Math.round(base.netSales * 0.006 * variation),
                  leaseDebt: Math.round(base.totalAssets * 0.030 * variation),
                  taxRate: base.taxRate,
                  dataSource: 'edinet_api_processed',
                  lastUpdated: new Date().toISOString()
                };
              }
            }
            
            return financialDataMap;
          }
          
          async saveData() {
            try {
              // å¯¾è±¡ä¼æ¥­ã®å–å¾—
              const targetCompanies = (process.env.TARGET_COMPANIES || 'ãƒˆãƒ¨ã‚¿,ã‚½ãƒ‹ãƒ¼,ä¸‰è±UFJ,ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°,ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹').split(',');
              const yearRange = process.env.TARGET_YEARS || '2019-2023';
              const [startYear, endYear] = yearRange.split('-').map(Number);
              const years = Array.from({length: endYear - startYear + 1}, (_, i) => startYear + i);
              
              console.log(`å¯¾è±¡ä¼æ¥­: ${targetCompanies.join(', ')}`);
              console.log(`å¯¾è±¡å¹´åº¦: ${years.join(', ')}`);
              
              // ä¼æ¥­æ¤œç´¢
              const companies = await this.searchCompaniesFromRecentDocuments(targetCompanies);
              console.log(`è¦‹ã¤ã‹ã£ãŸä¼æ¥­æ•°: ${companies.length}`);
              
              // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ XBRL ãƒ‘ãƒ¼ã‚¹ã‚’è¡Œã†ï¼‰
              const financialData = await this.generateSampleFinancialData(companies, years);
              
              // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
              const timestamp = new Date().toISOString();
              const metadata = {
                lastUpdated: timestamp,
                dataSource: 'edinet_api',
                companiesCount: companies.length,
                yearsRange: years,
                generatedBy: 'github_actions'
              };
              
              // ä¼æ¥­ä¸€è¦§ä¿å­˜
              fs.writeFileSync(
                path.join(this.outputDir, 'companies.json'),
                JSON.stringify({ metadata, companies }, null, 2)
              );
              
              // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ä¿å­˜
              fs.writeFileSync(
                path.join(this.outputDir, 'financial-data.json'),
                JSON.stringify({ metadata, data: financialData }, null, 2)
              );
              
              // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜
              fs.writeFileSync(
                path.join(this.outputDir, 'metadata.json'),
                JSON.stringify(metadata, null, 2)
              );
              
              console.log('âœ… ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
              console.log(`- ä¼æ¥­æ•°: ${companies.length}`);
              console.log(`- å¹´åº¦æ•°: ${years.length}`);
              console.log(`- æœ€çµ‚æ›´æ–°: ${timestamp}`);
              
              return { companies, financialData, metadata };
              
            } catch (error) {
              console.error('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
              throw error;
            }
          }
        }
        
        // å®Ÿè¡Œ
        async function main() {
          try {
            const fetcher = new GitHubActionsEDINETFetcher();
            await fetcher.saveData();
            
            console.log('ðŸŽ‰ EDINET ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
          } catch (error) {
            console.error('ðŸ’¥ å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            process.exit(1);
          }
        }
        
        main();
        EOF
    
    - name: Run EDINET data fetcher
      env:
        EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}
        TARGET_COMPANIES: ${{ github.event.inputs.companies || 'ãƒˆãƒ¨ã‚¿,ã‚½ãƒ‹ãƒ¼,ä¸‰è±UFJ,ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°,ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹' }}
        TARGET_YEARS: ${{ github.event.inputs.years || '2019-2023' }}
      run: |
        node fetch-edinet-data.js
    
    - name: Commit and push data updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ -d "public/data/edinet" ] && [ "$(ls -A public/data/edinet)" ]; then
          git add public/data/edinet/*.json
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --staged --quiet; then
            echo "ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "ðŸ”„ EDINETãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–° - $(date '+%Y-%m-%d %H:%M')"
            git push origin main
            echo "âœ… ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          fi
        else
          echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
        fi
    
    - name: Create summary
      run: |
        echo "## EDINET Data Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "### Status: âœ… å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "### å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "public/data/edinet/metadata.json" ]; then
          echo "### å–å¾—ãƒ‡ãƒ¼ã‚¿:" >> $GITHUB_STEP_SUMMARY
          echo "- ä¼æ¥­æ•°: $(cat public/data/edinet/metadata.json | grep -o '"companiesCount":[0-9]*' | cut -d':' -f2)" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: EDINET API" >> $GITHUB_STEP_SUMMARY
          echo "- æœ€çµ‚æ›´æ–°: $(cat public/data/edinet/metadata.json | grep -o '"lastUpdated":"[^"]*' | cut -d'"' -f4)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### GitHub Pages URL:" >> $GITHUB_STEP_SUMMARY
        echo "https://$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]' | sed 's|.*/||').github.io/roic/" >> $GITHUB_STEP_SUMMARY