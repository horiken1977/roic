const fs = require('fs');

/**
 * æœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸çªåˆç”¨Excelå½¢å¼å‡ºåŠ›
 */
function exportExcelFinal() {
  console.log('ğŸ“Š æœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸çªåˆç”¨Excelå‡ºåŠ›');
  console.log('=' .repeat(60));
  
  try {
    // æœ€çµ‚ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    const finalTestFile = 'toyota_final_test_2025-07-06.json';
    if (!fs.existsSync(finalTestFile)) {
      console.log('âŒ æœ€çµ‚ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return false;
    }
    
    const finalData = JSON.parse(fs.readFileSync(finalTestFile, 'utf8'));
    
    console.log('ğŸ“‹ Excelç”¨ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆä¸­...');
    
    // åŸºæœ¬æƒ…å ±CSV
    const basicInfo = [
      ['é …ç›®', 'å€¤', 'å‚™è€ƒ'],
      ['ä¼æ¥­å', finalData.ä¼æ¥­å, 'æ­£å¼åç§°'],
      ['EDINETã‚³ãƒ¼ãƒ‰', finalData.EDINETã‚³ãƒ¼ãƒ‰, ''],
      ['æ±ºç®—å¹´åº¦', finalData.æ±ºç®—å¹´åº¦, ''],
      ['ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹', finalData.ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹, ''],
      ['æŠ½å‡ºæ—¥æ™‚', finalData.æŠ½å‡ºæ—¥æ™‚, '']
    ];
    
    // è²¡å‹™ãƒ‡ãƒ¼ã‚¿è©³ç´°CSV
    const financialData = [
      ['è²¡å‹™é …ç›®', 'APIå–å¾—å€¤ï¼ˆå††ï¼‰', 'è¡¨ç¤ºå½¢å¼', 'XBRLè¦ç´ å', 'çŠ¶æ…‹', 'æœ‰å ±è¨˜è¼‰å€¤', 'å·®ç•°', 'å‚™è€ƒ'],
      [
        'å£²ä¸Šé«˜',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å£²ä¸Šé«˜?.å€¤ || '',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å£²ä¸Šé«˜?.è¡¨ç¤º || '',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å£²ä¸Šé«˜?.XBRLè¦ç´  || '',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å£²ä¸Šé«˜?.çŠ¶æ…‹ || '',
        '', // æ‰‹å‹•å…¥åŠ›ç”¨
        '', // å·®ç•°è¨ˆç®—ç”¨
        'é€£çµå£²ä¸Šé«˜'
      ],
      [
        'å–¶æ¥­åˆ©ç›Š',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å–¶æ¥­åˆ©ç›Š?.å€¤ || '',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å–¶æ¥­åˆ©ç›Š?.è¡¨ç¤º || '',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å–¶æ¥­åˆ©ç›Š?.XBRLè¦ç´  || '',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å–¶æ¥­åˆ©ç›Š?.çŠ¶æ…‹ || '',
        '', // æ‰‹å‹•å…¥åŠ›ç”¨
        '', // å·®ç•°è¨ˆç®—ç”¨
        'é€£çµå–¶æ¥­åˆ©ç›Š'
      ],
      [
        'ç·è³‡ç”£',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.ç·è³‡ç”£?.å€¤ || '',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.ç·è³‡ç”£?.è¡¨ç¤º || '',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.ç·è³‡ç”£?.XBRLè¦ç´  || '',
        finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.ç·è³‡ç”£?.çŠ¶æ…‹ || '',
        '', // æ‰‹å‹•å…¥åŠ›ç”¨
        '', // å·®ç•°è¨ˆç®—ç”¨
        'é€£çµç·è³‡ç”£'
      ]
    ];
    
    // ROICè¨ˆç®—è©³ç´°CSV
    const roicData = [
      ['è¨ˆç®—é …ç›®', 'å€¤', 'å˜ä½', 'å‚™è€ƒ'],
      ['å–¶æ¥­åˆ©ç›Šç‡', finalData.ROICè¨ˆç®—?.å–¶æ¥­åˆ©ç›Šç‡ || '', '%', ''],
      ['ç·è³‡ç”£å›è»¢ç‡', finalData.ROICè¨ˆç®—?.ç·è³‡ç”£å›è»¢ç‡ || '', 'å›', ''],
      ['ROIC', finalData.ROICè¨ˆç®—?.ROIC || '', '%', ''],
      ['è¨ˆç®—æ–¹å¼', finalData.ROICè¨ˆç®—?.è¨ˆç®—æ–¹å¼ || '', '', '']
    ];
    
    // æœ‰å ±ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆCSV
    const checklist = [
      ['ç¢ºèªé …ç›®', 'APIå–å¾—å€¤', 'æœ‰å ±è¨˜è¼‰å€¤ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰', 'å·®ç•°', 'ç¢ºèªçŠ¶æ³', 'å‚™è€ƒ'],
      ['å£²ä¸Šé«˜', finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å£²ä¸Šé«˜?.è¡¨ç¤º || '', '', '', 'æœªç¢ºèª', 'é€£çµæç›Šè¨ˆç®—æ›¸'],
      ['å–¶æ¥­åˆ©ç›Š', finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å–¶æ¥­åˆ©ç›Š?.è¡¨ç¤º || '', '', '', 'æœªç¢ºèª', 'é€£çµæç›Šè¨ˆç®—æ›¸'],
      ['ç·è³‡ç”£', finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.ç·è³‡ç”£?.è¡¨ç¤º || '', '', '', 'æœªç¢ºèª', 'é€£çµè²¸å€Ÿå¯¾ç…§è¡¨'],
      ['', '', '', '', '', ''],
      ['ç¢ºèªæ‰‹é †', '', '', '', '', ''],
      ['1. EDINETã‚¢ã‚¯ã‚»ã‚¹', 'https://disclosure.edinet-fsa.go.jp/', '', '', '', ''],
      ['2. ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Šæ¤œç´¢', 'è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰: 7203', '', '', '', ''],
      ['3. 2024å¹´åº¦æœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸', '', '', '', '', ''],
      ['4. é€£çµæç›Šè¨ˆç®—æ›¸ç¢ºèª', 'å£²ä¸Šé«˜ãƒ»å–¶æ¥­åˆ©ç›Š', '', '', '', ''],
      ['5. é€£çµè²¸å€Ÿå¯¾ç…§è¡¨ç¢ºèª', 'ç·è³‡ç”£', '', '', '', ''],
      ['', '', '', '', '', ''],
      ['åˆ¤å®šåŸºæº–', '', '', '', '', ''],
      ['å·®ç•°Â±5%ä»¥å†…', 'è‰¯å¥½', '', '', '', ''],
      ['å·®ç•°Â±10%ä»¥å†…', 'è¨±å®¹', '', '', '', ''],
      ['å·®ç•°Â±10%è¶…', 'è¦èª¿æŸ»', '', '', '', '']
    ];
    
    // CSVæ–‡å­—åˆ—ç”Ÿæˆé–¢æ•°
    function arrayToCSV(data) {
      return data.map(row => 
        row.map(cell => {
          const str = String(cell || '');
          if (str.includes(',') || str.includes('"')) {
            return `"${str.replace(/"/g, '""')}"`;
          }
          return str;
        }).join(',')
      ).join('\n');
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
    console.log('ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ä¸­...');
    
    fs.writeFileSync('toyota_åŸºæœ¬æƒ…å ±.csv', arrayToCSV(basicInfo), 'utf8');
    fs.writeFileSync('toyota_è²¡å‹™ãƒ‡ãƒ¼ã‚¿.csv', arrayToCSV(financialData), 'utf8');
    fs.writeFileSync('toyota_ROICè¨ˆç®—.csv', arrayToCSV(roicData), 'utf8');
    fs.writeFileSync('toyota_æœ‰å ±ç¢ºèª.csv', arrayToCSV(checklist), 'utf8');
    
    // çµ±åˆç‰ˆä½œæˆ
    const combined = [
      'ã€åŸºæœ¬æƒ…å ±ã€‘',
      arrayToCSV(basicInfo),
      '',
      'ã€è²¡å‹™ãƒ‡ãƒ¼ã‚¿è©³ç´°ã€‘',
      arrayToCSV(financialData),
      '',
      'ã€ROICè¨ˆç®—è©³ç´°ã€‘',
      arrayToCSV(roicData),
      '',
      'ã€æœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‘',
      arrayToCSV(checklist)
    ].join('\n');
    
    // BOMä»˜ãUTF-8ã§ä¿å­˜ï¼ˆExcelå¯¾å¿œï¼‰
    const bom = '\uFEFF';
    fs.writeFileSync('toyota_å®Œå…¨ç‰ˆ.csv', bom + combined, 'utf8');
    
    console.log('âœ… Excelå½¢å¼å‡ºåŠ›å®Œäº†ï¼');
    
    console.log('\nğŸ“ ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«:');
    console.log('1. toyota_åŸºæœ¬æƒ…å ±.csv');
    console.log('2. toyota_è²¡å‹™ãƒ‡ãƒ¼ã‚¿.csv');
    console.log('3. toyota_ROICè¨ˆç®—.csv');
    console.log('4. toyota_æœ‰å ±ç¢ºèª.csv');
    console.log('5. toyota_å®Œå…¨ç‰ˆ.csv (çµ±åˆãƒ»BOMä»˜ã)');
    
    console.log('\nğŸ“‹ æœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸çªåˆæ‰‹é †:');
    console.log('1. toyota_æœ‰å ±ç¢ºèª.csv ã‚’Excelã§é–‹ã');
    console.log('2. EDINET ã§ ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Šï¼ˆ7203ï¼‰ã‚’æ¤œç´¢');
    console.log('3. 2024å¹´åº¦æœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸ã‚’ç¢ºèª');
    console.log('4. é€£çµè²¡å‹™è«¸è¡¨ã®æ•°å€¤ã‚’è»¢è¨˜');
    console.log('5. å·®ç•°ã‚’è¨ˆç®—ãƒ»è©•ä¾¡');
    
    console.log('\nğŸ¯ APIå–å¾—ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼:');
    console.log(`å£²ä¸Šé«˜: ${finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å£²ä¸Šé«˜?.è¡¨ç¤º}`);
    console.log(`å–¶æ¥­åˆ©ç›Š: ${finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.å–¶æ¥­åˆ©ç›Š?.è¡¨ç¤º}`);
    console.log(`ç·è³‡ç”£: ${finalData.è²¡å‹™ãƒ‡ãƒ¼ã‚¿.ç·è³‡ç”£?.è¡¨ç¤º}`);
    console.log(`ROIC: ${finalData.ROICè¨ˆç®—?.ROIC}`);
    
    return true;
    
  } catch (error) {
    console.error('âŒ Excelå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}

// å®Ÿè¡Œ
const success = exportExcelFinal();

if (success) {
  console.log('\nğŸ‰ æœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸çªåˆç”¨Excelãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†ï¼');
} else {
  console.log('\nâŒ Excelå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
}